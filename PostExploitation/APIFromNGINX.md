### Build API from NGINX
The nginx config only defines the route that the request will take by sending the traffic to whichever application.

**Step 1:** Analyze the ngnix config files to see which routes are defined. It exposes how many different applications are there.

Do it manually by looking for *location* and *proxy_pass* but review with:
```bash
grep -rP '\blocation\s\K\/\S+' /etc/nginx/* 2> /dev/null | awk '{print $3}'
grep -rP '\bproxy_pass\s\K\/\S+' /etc/nginx/* 2> /dev/null | awk '{print $3}'
```

**Step 2:** Identify the applications found that are responsible for handling these routes
		
```bash
netstat -vplan # For PID
cat /proc/PID/cmdline # might fail if the binary has been moved
ls -la /proc/PID/exe	# Will show symlink 
lsof -n | grep PID | grep ' txt ' 
```
		
**Step 3:** Do we have the code or a binary that we can decompile?

E.g for a Java app:
1. Use jd-gui to decompile to source code
2. Save the .java files into a folder called src

**Step 4:** Write a Semgrp to parse all java files for @PATH($PATH) decorators above API methods and save output into a JSON.  
@TODO: Other languages
@TODO: Write semgrep that finds additional @NoAuth decorators to find paths that do not require auhtentication

```yaml
rules:
	- id: find_paths_id
	  patterns:
	    - pattern-inside: |
		@Path($CLASSPATH)
		class $CLASS{
		  ...
		}
	    - pattern: |
		@Path($METHODPATH)
		$RETURN $METHOD(...){
		  ...
		}
	  message: Find all @path annotations
	  languages: [java]
	  severity: INFO
```

Run with
```bash
semgrep -c pathannotations.yaml . --max-lines-per-finding 5 -o out.json --json
```

**Step 5:** Write quick python to analyze the output.json to generate the API
```python
import json

def readJSON():
	with open('out.json', 'r') as f:

	data = json.load(f)

	for element in data['results']:
		classpath = element['extra']['metavars']['$CLASSPATH']['abstract_content']
		methodpath = element['extra']['metavars']['$METHODPATH']['abstract_content']

		entireString= classpath+methodpath
		print(entireString.replace('"', ""))

def main():
	readJSON()

if __name__ == "__main__":
	main()
```