# How to get in-between

## The No-Proxy Option
If we see some errors in the Burp Dashboard like
"The Client failed to establish a TLS connection..."
it could imply that the app is using certificate pinning. One way to circumvent this is to decompile the app and grep for all occurrences of the URL e.g. https://example.com

1. Decompile with [Jadx](https://github.com/skylot/jadx/releases/tag/v1.3.5) , [bytecode-viewer](https://github.com/konloch/bytecode-viewer/releases), or [apktool](https://ibotpeaches.github.io/Apktool/)
2. Find all occurrences of https://example.com with `grep "https://example.com" \* R`
3. Write a script to replace these occurences with you BurpListeners address such as below
```python

path1 = "/home/bob/mobile/testapp_out/res/values/strings.xml"
path2 = "/home/bob/mobile/testapp_out/assets/index.android.bundle"  

filePathArray = [path1, path2]  

for item in filePathArray:  
    with open(item, 'r') as file:  
        filedata = file.read()  

    # Replace the target string  
    filedata = filedata.replace('https://example.com', 'http://192.168.1.155:7575')  

    # Write the file out again  
    with open(item, 'w') as file:  
        file.write(filedata)
```

4. Repackage and Sign with [apksigner](https://developer.android.com/studio/command-line/apksigner)or [uber-apk-signer]](https://github.com/patrickfav/uber-apk-signer)
5. Install with `adb install myapk`

### Automated
These steps can be automated using the scripts
- [from Android 11] (https://gist.githubusercontent.com/floyd-fuh/7f7408b560672ece3ea78348559d47b6/raw/f24ac2df0752dcb69152b343a98deffd8cf1db69/repackage_apk_for_burp.py)
- [Before Android 11](https://github.com/laconicwolf/Android-App-Testing/blob/master/repackage_apk_for_burp.py)

I needed to change the code a bit you can find it here **TODO**

I put in a **input("Click once you modified the decompiled code")** after the script decompiled the APK. This gives me the oppurtunity to find and replace example.com with my IP as mentioned before.

Once you replaced it press enter and install the APK


## Inject Frida-Gadget
https://fadeevab.com/frida-gadget-injection-on-android-no-root-2-methods/

Frida’s Gadget is a shared library meant to be loaded by programs to be instrumented when the Injected mode of operation isn’t suitable. There are two ways to inject a frida gadget.

1. If the APK contains native libraries (often under /apkname/lib/arm64-v8a/mysharedobject.so) you can inject libfrida-gadget.so into them. It might be difficult to know which and if the shared libraries are executed. Therefore you can inject all of them (I am not sure if this causes problems but I tried it and it worked smoothly)
2. If the APK does not contain native libraries you can inject System.LoadLibrary Bytecode

### Option 1: Inject Frida Gadget in Shared Object
Check out the scripts inject-gadget-native-arm(64).py. These scripts include all steps that need to be done manually

### Option 2: Inject Frida Gadget in Smali Code
Check out the script inject-gadget-smali-arm64.py. The script includes all but the very manual script of inserting the frida-gadget into the MainActivity.

1. Decode the APK  `apktool d -o out_dir original.apk2`

2. Inject a System.loadLibrary("frida-gadget") call into the bytecode of the app. Preferable in the beginning of the call order.
2.1 Find main Activity with `grep -ri "MainActivity" *`or by investigating the AndroidManifest.xml
2.2 Add the following smali code into a suitable function```const-string v0, "frida-gadget"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V```
3. Give the App internet permission if not already given by adding the following line into the AndroidManifest.xml `<uses-permission android:name="android.permission.INTERNET" />`
4. Repack and sign
```
apktool b myapk
wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.2.1/uber-apk-signer-1.2.1.jar
java -jar uber-apk-signer-1.2.1.jar -a ./myapk/dist/myapk.apk
```
5. `Install adb install myapk`




## TroubleShooting and Additional Infos

### Repack  
Newer Android versions (>11) requires different signature scheme
https://developer.android.com/about/versions/11/behavior-changes-11#minimum-signature-scheme
