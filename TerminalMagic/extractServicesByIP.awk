## Run awk -f extractServicesByIP.awk scan.nmap
# Creds to Ed Morton from StackOverflow

# This script is parsing a NMAP file for open ports on all machines and groups them into the services.
# This gives a nice overview of services in bigger scoped networks.
# Example output
#
#   22/ssh
#   ====
#   192.168.1.1
#   192.168.1.6
#
#   80/http
#   ====
#   192.168.1.4
#   192.168.17


BEGIN { FS="[[:space:]/]+" }

/Nmap scan report/ {
    ip = $NF
    gsub(/[()]/,"",ip)
}

/tcp.*open/ {
    key = $1 "/" $4
    ips[key] = (key in ips ? ips[key] ORS : "") ip
}

END {
    for (key in ips) {
        print key
        print "===="
        print ips[key]
        print ""
    }
}
